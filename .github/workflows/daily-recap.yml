name: Daily Portfolio Recap

on:
  schedule:
    - cron: '0 10 * * 1-5'  # 11:00 CET (10:00 UTC) - European market open (monday-friday)
    - cron: '0 15 * * 1-5'  # 16:00 CET (15:00 UTC) - U.S. market open (monday-friday)
    - cron: '0 22 * * 1-5'  # 23:00 CET (22:00 UTC) - U.S. market close (monday-friday)
    - cron: '0 9 * * 6'     # 10:00 CET (09:00 UTC) - Weekly recap (Saturday)
    - cron: '0 21 * * 0'    # 22:00 CET (21:00 UTC) - Weekly recap (Sunday)
    - cron: '0 20 28-31 * *'  # 21:00 CET (20:00 UTC) - Monthly recap check (last day of month)
  workflow_dispatch:  # Allows manual trigger
    inputs:
      force_session:
        description: 'Force Session Name (e.g. "Weekly recap (Sat)")'
        required: false
        type: string

jobs:
  generate-recap:
    runs-on: ubuntu-latest
    environment: Etoro
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      

      - name: Determine market session
        id: market_session
        run: |
          # Ottiene l'ora corrente in UTC (00-23) e giorno (1-7)
          HOUR=$(date -u +%H)
          DAY=$(date -u +%u)
          
          # Remove leading zero from hour if present to avoid octal interpretation
          HOUR=${HOUR#0}
          
          # Controlla quale ora schedulata ha attivato l'azione
          SESSION_NAME="Daily recap"
          FORCED_SESSION="${{ inputs.force_session }}"
          
          if [ -n "$FORCED_SESSION" ]; then
             SESSION_NAME="$FORCED_SESSION"
             echo "ðŸ”’ Session forced to: $SESSION_NAME"
          # Check if it's the last day of the month (tomorrow is day 1)
          elif [ "$HOUR" -eq 20 ]; then
             TOMORROW=$(date -u -d "+1 day" +%d)
             if [ "$TOMORROW" == "01" ]; then
               SESSION_NAME="Monthly recap"
               echo "ðŸ“… Last day of month detected - Monthly recap"
             fi
          elif [ "$DAY" -eq 6 ] && [ "$HOUR" -eq 9 ]; then
             SESSION_NAME="Weekly recap (Sat)"
          elif [ "$DAY" -eq 7 ] && [ "$HOUR" -eq 21 ]; then
             SESSION_NAME="Weekly recap (Sun)"
          elif [ "$HOUR" -eq 10 ]; then
            SESSION_NAME="European market open"
          elif [ "$HOUR" -eq 15 ]; then
            SESSION_NAME="U.S. market open"
          elif [ "$HOUR" -eq 22 ]; then
            SESSION_NAME="U.S. market close"
          fi
          
          # Imposta la variabile di output
          echo "session=$SESSION_NAME" >> "$GITHUB_OUTPUT"
          echo "Market Session detected: $SESSION_NAME (UTC Hour: $HOUR, Day: $DAY)"
                
      - name: Debug Environment Variables
        env:
          MARKET_SESSION: ${{ steps.market_session.outputs.session }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "=== DEBUG VARIABLES ==="
          echo "MARKET_SESSION: $MARKET_SESSION"
          echo "SPREADSHEET_ID: $SPREADSHEET_ID"
          echo "TELEGRAM_CHAT_ID: $TELEGRAM_CHAT_ID"
          echo "Checking GOOGLE_SHEETS_CREDENTIALS length: ${#SECRETS_GOOGLE_SHEETS_CREDENTIALS}"
          echo "GIST_ID configured: ${{ secrets.GIST_ID != '' }}"
          echo "======================="

      - name: Collect data and generate recap
        env:
          GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
          ORO_USERNAME: ${{ secrets.ETORO_USERNAME }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MARKET_SESSION: ${{ steps.market_session.outputs.session }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Gist storage configuration
          # Gist storage configuration
          GIST_ACCESS_TOKEN: ${{ secrets.GIST_ACCESS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          python src/data_collector.py
      
      - name: Upload recap as artifact
        uses: actions/upload-artifact@v5.0.0
        with:
          name: daily-recap
          path: |
            output/recap.txt
            output/performance_chart.png
            output/gemini_api_usage.json
            output/gemini_api_usage_report.txt
      
      - name: Display recap
        run: cat output/recap.txt
      
      - name: Display API Usage Report
        run: |
          echo "ðŸ“Š Gemini API Usage Report:"
          cat output/gemini_api_usage_report.txt || echo "No API usage report generated"

